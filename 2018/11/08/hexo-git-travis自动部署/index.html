<!DOCTYPE html><html><head><meta name="description" content="web 前端开发"/><meta name="author" content="Fantasy"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta http-equiv="XUA_Compatible" content="IE=edge"/><meta name="sw" content="true"/><meta name="ga" content="UA-101492756-1"/><meta name="ba" content="044e5dc9f3bc0a3b3042d15a4bbd8cae"/><link rel="icon" href="/favicon/favicon.ico"/><link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"/><link rel="stylesheet" href="https://unpkg.com/firement@0.0.5/dist/style.css"/><link rel="stylesheet" href="/css/layout.css"/><title>幻想❤乡 - hexo+git+travis自动部署</title><meta name="generator" content="Hexo 5.0.0"></head><body><nav class="simple-layout-nav"><div class="simple-navbar"><div class="avatar-box"><a class="avatar-img" href="/"><img src="/imgs/avatar.jpg" alt="" srcset=""/></a><a class="info" href="/"><h3 class="author">Fantasy</h3><small class="subtitle">累了，就来这里歇歇</small></a></div><div class="menu"><span class="home"><a href="/"><i class="fa fa-home"></i>主页</a></span><span class="archives"><a href="/archives"><i class="fa fa-archive"></i>归档</a></span><span class="tags"><a href="/tags"><i class="fa fa-tag"></i>标签</a></span></div><div class="links"><span class="item"><a href="https://github.com//0x-jerry" target="_blank" rel="noopener"><i class="fa fa-github"></i><span>Github</span></a></span><span class="item"><a href="mailto:x.li.gem@gmail.com" target="_blank" rel="noopener"><i class="fa fa-envelope"></i><span>Email</span></a></span></div></div></nav><div class="simple-layout-content"><div class="simple-post"><h1 class="title">hexo+git+travis自动部署</h1><p class="post-meta"><span class="meta date">2018-11-08</span><span class="meta license"><a alt="CC BY-NC 4.0" href="https://creativecommons.org/licenses/by-nc/4.0/deed.zh" target="_blank">CC BY-NC 4.0</a></span></p><div class="markdown-content" id="post-content"><blockquote>
<p>本文介绍如何使用 TravisCI 来实现 <code>git push</code> 之后，自动更新 GitHub Page</p>
</blockquote>
<h2 id="准备">准备</h2>
<p>本文章，默认读者已熟悉 travis 配置，以及 git 相关命令</p>
<h2 id="流程">流程</h2>
<ol>
<li>git push</li>
<li>travis 执行脚本
<ol>
<li>安装依赖 <code>npm install</code> or <code>yarn</code></li>
<li>配置 git global config<a id="more"></a>
</li>
<li>clone git page 仓库</li>
<li>生成 html 静态文件</li>
<li>commit 更新时间</li>
<li>push</li>
</ol>
</li>
</ol>
<h2 id="生成-github-token">生成 github token</h2>
<p>生成 token, 让 travis 可以根据 token 拿到 push 到 git 的权限</p>
<p><a target="_blank" rel="noopener" href="https://github.com/settings/tokens">生成 token 地址</a></p>
<p><img src="gen-new-token.png" alt="gen-new-token"></p>
<p>生成新的 token 之后，在 travis 对应的仓库里面设置环境变量</p>
<p><img src="settings.png" alt="settings"></p>
<p>之后就是写配置文件了</p>
<h2 id="Travis-Config">Travis Config</h2>
<p>确定流程之后，就可以开始写配置文件 <code>.travis.yml</code>:</p>
<blockquote>
<p><code>date '+%Y-%m-%d %H:%M:%S'</code> 是获取系统时间，具体参考 <a target="_blank" rel="noopener" href="http://manpages.ubuntu.com/manpages/cosmic/man1/date.1.html">date command</a>, <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/4651437/how-to-set-a-variable-to-the-output-of-a-command-in-bash">set variable in bash</a></p>
</blockquote>
<ul>
<li>git commit -m &quot;Site updated - <code>date '+%Y-%m-%d %H:%M:%S'</code>&quot;</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">language:</span> <span class="hljs-string">node_js</span><br><span class="hljs-attr">node_js:</span> <span class="hljs-string">stable</span><br><br><span class="hljs-attr">before_install:</span> <span class="hljs-comment"># 配置 git global config</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">git</span> <span class="hljs-string">config</span> <span class="hljs-string">user.name</span> <span class="hljs-string">&quot;cwxyz007&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">git</span> <span class="hljs-string">config</span> <span class="hljs-string">user.email</span> <span class="hljs-string">&quot;jie844067636@gmail.com&quot;</span><br><br><span class="hljs-attr">install:</span> <span class="hljs-comment"># 安装依赖</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">yarn</span><br><br><span class="hljs-attr">before_script:</span> <span class="hljs-comment"># clone git page 仓库到 public 文件夹</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">mkdir</span> <span class="hljs-string">./public</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">cd</span> <span class="hljs-string">./public</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">git</span> <span class="hljs-string">clone</span> <span class="hljs-string">&quot;https://$&#123;GitRepo&#125;&quot;</span> <span class="hljs-string">.</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">cd</span> <span class="hljs-string">..</span><br><br><span class="hljs-attr">script:</span> <span class="hljs-comment"># 生成 html 静态文件</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">hexo</span> <span class="hljs-string">g</span><br><br><span class="hljs-attr">after_script:</span> <span class="hljs-comment"># commit 更新时间 以及 push</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">cd</span> <span class="hljs-string">./public</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">git</span> <span class="hljs-string">add</span> <span class="hljs-string">.</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">git</span> <span class="hljs-string">commit</span> <span class="hljs-string">-m</span> <span class="hljs-string">&quot;Site updated - `date &#x27;+%Y-%m-%d %H:%M:%S&#x27;`&quot;</span><br>  <span class="hljs-comment"># GitToken 为上面配置的环境变量</span><br>  <span class="hljs-comment"># GitRepo 在 env.global 有配置</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">git</span> <span class="hljs-string">push</span> <span class="hljs-string">&quot;https://$&#123;GitToken&#125;@$&#123;GitRepo&#125;&quot;</span> <span class="hljs-string">master:master</span><br><br><span class="hljs-attr">branches:</span><br>  <span class="hljs-attr">only:</span> <span class="hljs-comment"># 只更新 master 分支</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">master</span><br><br><span class="hljs-attr">cache:</span> <span class="hljs-comment"># 缓存 node_module 加快更新速度</span><br>  <span class="hljs-attr">yarn:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">npm:</span> <span class="hljs-literal">true</span><br><br><span class="hljs-attr">env:</span> <span class="hljs-comment">#环境变量</span><br>  <span class="hljs-attr">global:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">TZ:</span> <span class="hljs-string">Asia/Shanghai</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">GitRepo:</span> <span class="hljs-string">github.com/cwxyz007/cwxyz007.github.io.git</span><br></code></pre></td></tr></table></figure>
<h2 id="坑">坑</h2>
<p>在配置 <code>git commit</code> 命令的时候，配置为</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">script:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">git</span> <span class="hljs-string">commit</span> <span class="hljs-string">-m</span> <span class="hljs-string">&quot;Site updated - `date &#x27;+%Y-%m-%d %H:%M:%S&#x27;`&quot;</span> <span class="hljs-comment"># 正确</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">git</span> <span class="hljs-string">commit</span> <span class="hljs-string">-m</span> <span class="hljs-string">&quot;Site updated: `date &#x27;+%Y-%m-%d %H:%M:%S&#x27;`&quot;</span> <span class="hljs-comment"># 错误</span><br></code></pre></td></tr></table></figure>
<p>提交上去之后，Travis 提示 command not found，通过查找，发现是 yaml 语法错误，因为 <code>Site updated</code> 后面的 <code>:</code> 没有转义，所以整句命令执行出错，谨记！</p>
</div><hr class="post-end"/><div class="post-footer"><div class="post-license">版权声明：本文使用 <a alt="CC BY-NC 4.0" href="https://creativecommons.org/licenses/by-nc/4.0/deed.zh" target="_blank">CC BY-NC 4.0</a> 协议</div><div class="partial-simple-tags"><ul><li><a href="/tags/Git/"><i class="fa fa-tag"></i>Git</a></li><li><a href="/tags/Hexo/"><i class="fa fa-tag"></i>Hexo</a></li><li><a href="/tags/Travis-CI/"><i class="fa fa-tag"></i>Travis CI</a></li></ul></div></div><div id="post-comment"></div></div></div><div id="post-nav"></div><div class="simple-footer"><p> Powered by
  <a class="footer-link" href="https://github.com//0x-jerry/hexo-simple-template" target="_blank" rel="noopener">Simple</a>
  and
  <a class="footer-link" href="https://hexo.io" target="_blank" rel="noopener">Hexo</a>
  , Made By
  <a class="footer-link" href="https://github.com//0x-jerry" target="_blank" rel="noopener">@Fantasy</a>
</p>
</div><script src="/js/index.js"></script></body></html>